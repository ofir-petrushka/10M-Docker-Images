IMAGE_NAME=rounds/10m-php-fpm:5.6

all:
	echo 'Usage: see https://github.com/rounds/10M-Docker-Images/blob/master/base/README.md'

update: 
	peru reup -f
	peru sync
	mv 5.6/fpm/* ./
	rm -rf 5.6
	sed -i -e "s/^FROM .*/FROM rounds\/10m-build/" Dockerfile # Inherit from our own docker tree
	sed -i -e "s|./configure \\\|./configure --enable-zip --enable-opcache --enable-mbstring=all \\\|" Dockerfile # Enable extentions
	sed -i -e "1s/^/\
# *** DO NOT EDIT THIS FILE MANUALLY ***\n\
# *** Will be overwritten by 'make update' ***\n/" Dockerfile # Outside file warning
	find . -type f -name "docker-php-ext-*" -exec sed -i -e "1s/^/\
# *** DO NOT EDIT THIS FILE MANUALLY ***\n\
# *** Will be overwritten by 'make update' ***\n/" {} + # Outside file warning

build:
	docker build --tag "$(IMAGE_NAME)" .

build-parent:
	$(MAKE) -C .. build-cascade

build-cascade: build-parent build

clean:
	docker rmi -f $(IMAGE_NAME)

clean-parent:
	$(MAKE) -C .. clean-cascade

clean-cascade: clean clean-parent

run:
	docker run --rm -it $(IMAGE_NAME) bash
